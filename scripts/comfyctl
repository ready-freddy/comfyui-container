#!/usr/bin/env bash
set -euo pipefail
CMD="${1:-status}"
PORT="${COMFY_PORT:-3000}"
WORKSPACE="${WORKSPACE:-/workspace}"
VENV="${PERSIST_VENV:-/workspace/.venvs/comfyui-perf}"
APP="$WORKSPACE/ComfyUI/main.py"
LOG="$WORKSPACE/logs/comfyui.$(date +%Y%m%dT%H%M%S).log"

case "$CMD" in
  start)
    pkill -f "python.*ComfyUI/main.py" || true
    nohup "${VENV}/bin/python" -u "$APP" --listen 0.0.0.0 --port "$PORT" >>"$LOG" 2>&1 &
    echo "started :$PORT (log $LOG)"
    ;;
  stop)
    pkill -f "python.*ComfyUI/main.py" || true
    echo "stopped"
    ;;
  status)
    pgrep -f "python.*ComfyUI/main.py" >/dev/null && echo "running" || echo "not running"
    ;;
  logs)
    tail -n 200 -F "$LOG"
    ;;
  *)
    echo "usage: $0 {start|stop|status|logs}"; exit 2;;
esac
